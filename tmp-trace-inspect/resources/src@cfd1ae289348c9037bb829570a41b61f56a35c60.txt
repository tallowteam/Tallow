import { test, expect } from './fixtures';

test.describe('Navigation', () => {
  test.describe('Main Pages', () => {
    test('should navigate to homepage and show key content', async ({ page }) => {
      await page.goto('/');

      // Check page title
      await expect(page).toHaveTitle(/Tallow/);

      // Check hero section
      await expect(page.locator('h1')).toBeVisible();
      await expect(page.locator('text=/peer-to-peer/i').first()).toBeVisible();

      // Check CTA button exists
      const ctaButton = page.getByRole('link', { name: /Start Transferring|OPEN APP/i }).first();
      await expect(ctaButton).toBeVisible();
    });

    test('should navigate to /features page', async ({ page }) => {
      await page.goto('/features');

      // Check page loaded
      await expect(page).toHaveTitle(/Features/);

      // Check features content visible
      await expect(page.locator('h1')).toBeVisible();

      // Check multiple feature cards
      await expect(page.locator('h2:has-text("Lightning-fast peer-to-peer")')).toBeVisible();
    });

    test('should navigate to /security page', async ({ page }) => {
      await page.goto('/security');

      // Check page loaded
      await expect(page).toHaveTitle(/Security/);

      // Check security content
      await expect(page.locator('h1')).toBeVisible();
      await expect(page.getByText('SECURITY', { exact: true }).first()).toBeVisible();

      // Check for encryption mentions
      await expect(page.locator('text=/encryption/i').first()).toBeVisible();
    });

    test('should navigate to /pricing page', async ({ page }) => {
      await page.goto('/pricing');

      // Check page loaded
      await expect(page).toHaveTitle(/Pricing/);

      // Check pricing content
      await expect(page.locator('h1')).toBeVisible();
      await expect(page.getByText('PRICING', { exact: true }).first()).toBeVisible();

      // Check free tier signal
      await expect(page.locator('text=$0')).toBeVisible();
    });

    test('should navigate to /about page', async ({ page }) => {
      await page.goto('/about');

      // Check page loaded
      await expect(page).toHaveTitle(/About/);

      // Check about content
      await expect(page.locator('h1')).toContainText(/Privacy is a fundamental right/i);
    });

    test('should navigate to /docs page', async ({ page }) => {
      await page.goto('/docs');

      // Check page loaded
      await expect(page).toHaveTitle(/Docs|Documentation/);

      // Check docs content
      await expect(page.locator('h1')).toBeVisible();
    });

    test('should navigate to /transfer page', async ({ page }) => {
      await page.goto('/transfer');

      // Check transfer app loaded
      await expect(page.locator('h1')).toContainText(/Choose your transfer mode/i);

      // Check transfer mode cards visible
      await expect(page.getByRole('button', { name: /Select Local Network mode/i })).toBeVisible();
      await expect(page.getByRole('button', { name: /Select Internet P2P mode/i })).toBeVisible();
      await expect(page.getByRole('button', { name: /Select Friends mode/i })).toBeVisible();
    });

    test('should navigate to /settings page', async ({ page }, testInfo) => {
      await page.goto('/settings');

      // Check settings page loaded
      await expect(page.locator('h1')).toContainText(/Settings/i);

      const isMobileProject = testInfo.project.name.toLowerCase().includes('mobile');
      if (isMobileProject) {
        const visibleSettingSections = page.getByRole('heading', {
          name: /Profile|Appearance|Privacy|Connection|Notifications|About/i,
        });
        await expect(visibleSettingSections.first()).toBeVisible();
      } else {
        // Check desktop settings sections visible
        await expect(page.getByRole('button', { name: 'Profile' }).first()).toBeVisible();
        await expect(page.getByRole('button', { name: 'Privacy' }).first()).toBeVisible();
      }
    });
  });

  test.describe('Header Navigation', () => {
    test('should have working header navigation links', async ({ page }, testInfo) => {
      const isMobileProject = testInfo.project.name.toLowerCase().includes('mobile');
      test.skip(isMobileProject, 'Desktop header-link visibility is validated separately from mobile dialog navigation.');

      await page.goto('/');

      // Check logo link
      const logo = page.locator('a[href="/"]').first();
      await expect(logo).toBeVisible();

      // Check navigation links
      await expect(page.locator('a[href="/features"]').first()).toBeVisible();
      await expect(page.locator('a[href="/how-it-works"]').first()).toBeVisible();
      await expect(page.locator('a[href="/docs"]').first()).toBeVisible();
      await expect(page.locator('a[href="/about"]').first()).toBeVisible();

      // Test clicking a nav link
      await page.locator('a[href="/features"]').first().click();
      await expect(page).toHaveURL(/\/features/);
    });

    test('should highlight active navigation link', async ({ page }) => {
      await page.goto('/features');

      // Find features link
      const featuresLink = page.locator('nav a[href="/features"]').first();

      // Check if it has active class or aria-current
      const ariaCurrent = await featuresLink.getAttribute('aria-current');
      const className = await featuresLink.getAttribute('class');

      expect(ariaCurrent === 'page' || className?.includes('active')).toBeTruthy();
    });

    test('should expose a valid theme state on document root', async ({ page }) => {
      await page.goto('/');

      // Theme should be represented on root element
      const html = page.locator('html');
      const dataTheme = await html.getAttribute('data-theme');
      expect(dataTheme).toBeTruthy();
    });

    test('should have GitHub link', async ({ page }) => {
      await page.goto('/');

      const githubLink = page.locator('a[href*="github"]').first();
      await expect(githubLink).toBeVisible();

      // Check it opens in new tab
      const target = await githubLink.getAttribute('target');
      expect(target).toBe('_blank');
    });

    test('should have Open App CTA button', async ({ page }, testInfo) => {
      await page.goto('/');

      const isMobileProject = testInfo.project.name.toLowerCase().includes('mobile');
      if (isMobileProject) {
        const menuButton = page.getByRole('button', { name: /toggle menu/i });
        await expect(menuButton).toBeVisible();
        await menuButton.click();
        await expect(menuButton).toHaveAttribute('aria-expanded', 'true');

        const mobileMenu = page.getByRole('dialog', { name: /navigation menu/i });
        await expect(mobileMenu).toBeVisible();

        const ctaButton = mobileMenu.getByRole('link', { name: /open app/i }).first();
        await expect(ctaButton).toBeVisible();
        await ctaButton.click();
        await expect(page).toHaveURL(/\/transfer/);
        return;
      }

      const ctaButton = page.locator('a[href="/transfer"]').or(page.locator('text=Open App')).first();

      await expect(ctaButton).toBeVisible();

      // Test clicking CTA
      await ctaButton.click();
      await expect(page).toHaveURL(/\/transfer/);
    });
  });

  test.describe('Footer Navigation', () => {
    test('should have footer on all pages', async ({ page }) => {
      const pages = ['/', '/features', '/security', '/pricing', '/about'];

      for (const url of pages) {
        await page.goto(url);
        const footer = page.locator('footer');
        await expect(footer).toBeVisible();
      }
    });

    test('should have footer links', async ({ page }) => {
      await page.goto('/');

      const footer = page.locator('footer');

      // Check product links
      await expect(footer.locator('a[href="/features"]').first()).toBeVisible();
      await expect(footer.locator('a[href="/security"]').first()).toBeVisible();
      await expect(footer.locator('a[href="/pricing"]').first()).toBeVisible();

      // Check docs link
      await expect(footer.locator('a[href="/docs"]')).toBeVisible();

      // Check legal links (if they exist)
      const privacyLink = footer.locator('a[href="/privacy"]');
      const termsLink = footer.locator('a[href="/terms"]');

      // At least one legal link should exist
      const hasPrivacy = await privacyLink.count() > 0;
      const hasTerms = await termsLink.count() > 0;
      expect(hasPrivacy || hasTerms).toBeTruthy();
    });

    test('should test footer link navigation', async ({ page }) => {
      await page.goto('/');

      // Click footer link
      await page.locator('footer a[href="/about"]').click();
      await expect(page).toHaveURL(/\/about/);
    });
  });

  test.describe('404 Page', () => {
    test('should show 404 page for unknown routes', async ({ page }) => {
      // Try to navigate to non-existent page
      const response = await page.goto('/this-page-does-not-exist-xyz123');

      // Check response status or page content
      // Next.js may return 200 with 404 content, or actual 404
      const status = response?.status();

      // Check for 404 indicators
      const has404Text = await page.locator('text=/404|not found/i').count() > 0;
      const has404Status = status === 404;

      expect(has404Text || has404Status).toBeTruthy();
    });

    test('should have link back to home from 404', async ({ page }) => {
      await page.goto('/non-existent-page-xyz');

      // Look for home link (common pattern)
      const homeLink = page.locator('a[href="/"]').or(
        page.locator('text=/go.*home/i')
      );

      // At least one way to get back home should exist
      const count = await homeLink.count();
      expect(count).toBeGreaterThan(0);
    });
  });

  test.describe('Mobile Navigation', () => {
    test.use({ viewport: { width: 375, height: 667 } });

    test('should show mobile menu button', async ({ page }) => {
      await page.goto('/');

      // Look for mobile menu button (hamburger)
      const menuButton = page.getByRole('button', { name: /toggle menu/i });

      await expect(menuButton).toBeVisible();
    });

    test('should open and close mobile menu', async ({ page }) => {
      await page.goto('/');

      // Find and click menu button
      const menuButton = page.getByRole('button', { name: /toggle menu/i });
      await expect(menuButton).toHaveAttribute('aria-expanded', 'false');
      await expect(menuButton).toBeVisible();
      await expect(menuButton).toBeEnabled();
      await menuButton.click();
      await expect(menuButton).toHaveAttribute('aria-expanded', 'true', { timeout: 15000 });

      // Check mobile menu visible
      const mobileMenu = page.getByRole('dialog', { name: /navigation menu/i });
      await expect(mobileMenu).toBeVisible();

      // Close menu
      await menuButton.click();
      await expect(menuButton).toHaveAttribute('aria-expanded', 'false', { timeout: 15000 });

      await expect(page.getByRole('dialog', { name: /navigation menu/i })).toHaveCount(0);
    });

    test('should navigate via mobile menu', async ({ page }) => {
      await page.goto('/');

      const menuButton = page.getByRole('button', { name: /toggle menu/i });
      await expect(menuButton).toBeVisible();
      await menuButton.click();

      // In rare CI frames the click can land directly on a menu link while the menu is opening.
      if (!/\/features/.test(page.url())) {
        const expanded = await menuButton.getAttribute('aria-expanded');
        if (expanded !== 'true') {
          await expect(menuButton).toHaveAttribute('aria-expanded', 'true', { timeout: 15000 });
        }

        const mobileMenu = page.getByRole('dialog', { name: /navigation menu/i });
        await expect(mobileMenu).toBeVisible();
        const featuresLink = mobileMenu.getByRole('link', { name: /features/i }).first();
        await expect(featuresLink).toBeVisible();
        await featuresLink.click();
      }

      await expect(page).toHaveURL(/\/features/);
    });
  });

  test.describe('Keyboard Navigation', () => {
    test('should navigate with keyboard', async ({ page, browserName }, testInfo) => {
      const isMobileProject = testInfo.project.name.toLowerCase().includes('mobile');
      test.skip(
        browserName === 'webkit' || isMobileProject,
        'Keyboard tab traversal is validated on desktop Chromium/Firefox; WebKit and mobile projects are inconsistent in CI.'
      );

      await page.goto('/');

      // Browser focus order differs (e.g. Firefox can focus non-actionable wrappers first),
      // so tab a few times until we land on a real interactive target.
      let focusedElement = {
        isInteractive: false,
        descriptor: '',
      };

      for (let i = 0; i < 6; i++) {
        await page.keyboard.press('Tab');

        focusedElement = await page.evaluate(() => {
          const el = document.activeElement;
          if (!el) {
            return { isInteractive: false, descriptor: '' };
          }

          const tagName = el.tagName;
          const role = el.getAttribute('role');
          const tabIndex = el.getAttribute('tabindex');
          const href = el.getAttribute('href');
          const id = el.getAttribute('id');
          const text = (el.textContent || '').trim().slice(0, 40);

          const isNativeInteractive =
            tagName === 'A' ||
            tagName === 'BUTTON' ||
            tagName === 'INPUT' ||
            tagName === 'SELECT' ||
            tagName === 'TEXTAREA' ||
            tagName === 'SUMMARY';
          const isRoleInteractive =
            role === 'link' ||
            role === 'button' ||
            role === 'tab' ||
            role === 'switch' ||
            role === 'checkbox';
          const isTabIndexInteractive = tabIndex !== null && tabIndex !== '-1';

          return {
            isInteractive: isNativeInteractive || isRoleInteractive || isTabIndexInteractive,
            descriptor: `${tagName}|${role ?? ''}|${id ?? ''}|${href ?? ''}|${text}`,
          };
        });

        if (focusedElement.isInteractive) {
          break;
        }
      }

      expect(
        focusedElement.isInteractive,
        `No interactive focus target reached. Last focus: ${focusedElement.descriptor}`
      ).toBeTruthy();
    });

    test('should close mobile menu with Escape key', async ({ page }) => {
      await page.setViewportSize({ width: 375, height: 667 });
      await page.goto('/');

      // Open mobile menu
      const menuButton = page.getByRole('button', { name: /toggle menu/i });
      await menuButton.click();

      // Press Escape
      await page.keyboard.press('Escape');

      // Check menu closed
      await expect(menuButton).toHaveAttribute('aria-expanded', 'false');
    });
  });

  test.describe('URL Parameters', () => {
    test('should preserve query parameters on navigation', async ({ page }, testInfo) => {
      await page.goto('/?ref=test');

      // Check parameter is in URL
      expect(page.url()).toContain('ref=test');

      const isMobileProject = testInfo.project.name.toLowerCase().includes('mobile');
      if (isMobileProject) {
        const menuButton = page.getByRole('button', { name: /toggle menu/i });
        await expect(menuButton).toBeVisible();
        await menuButton.click();
        await expect(menuButton).toHaveAttribute('aria-expanded', 'true');

        const mobileMenu = page.getByRole('dialog', { name: /navigation menu/i });
        await expect(mobileMenu).toBeVisible();
        await mobileMenu.getByRole('link', { name: 'FEATURES', exact: true }).first().click();
      } else {
        // Navigate to another page
        await page.locator('a[href="/features"]').first().click();
      }

      // URL should be on features page
      await expect(page).toHaveURL(/\/features/);
    });
  });
});
