# ============================================================================
# Docker Compose Override for Synology NAS Deployment
# Optimized resource constraints for NAS environments
# Usage: docker-compose -f docker-compose.yml -f docker-compose.synology.yml up -d
# ============================================================================

version: '3.8'

services:
  tallow:
    # Resource limits appropriate for Synology NAS (adjust based on your NAS model)
    deploy:
      resources:
        limits:
          cpus: '1.5'      # Reduced from 2 for NAS compatibility
          memory: 1.5G     # Reduced from 2G for NAS compatibility
        reservations:
          cpus: '0.25'     # Reduced from 0.5
          memory: 256M     # Reduced from 512M
    # Volume mounts for persistent data on NAS
    volumes:
      # Application data persistence
      - ${DATA_VOLUME_PATH:-/volume1/docker/tallow/data}:/app/data
      # Cache directory (optional, helps with build cache)
      - ${CACHE_VOLUME_PATH:-/volume1/docker/tallow/cache}:/app/.next/cache
    # Logging adjustments for NAS (reduced log sizes)
    logging:
      driver: "json-file"
      options:
        max-size: "5m"     # Reduced from 10m for NAS storage
        max-file: "2"      # Reduced from 3

  signaling:
    # Resource limits for relay server on NAS
    deploy:
      resources:
        limits:
          cpus: '0.5'      # Reduced from 1
          memory: 256M     # Reduced from 512M
        reservations:
          cpus: '0.1'      # Reduced from 0.25
          memory: 64M      # Reduced from 128M
    # Volume mounts for relay data (optional)
    volumes:
      - ${RELAY_DATA_PATH:-/volume1/docker/tallow/relay-data}:/app/data
    # Logging adjustments
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

# ============================================================================
# Networks - Synology specific configuration
# ============================================================================
networks:
  tallow-network:
    # Use Synology's native network bridge if available
    # This improves performance and stability on Synology systems
    driver: bridge
    name: tallow-network
    driver_opts:
      com.docker.network.bridge.name: br-tallow
      # Enable promiscuous mode for better network access on NAS
      com.docker.network.bridge.default_bridge: "false"

# ============================================================================
# Volumes - Synology persistent storage
# ============================================================================
volumes:
  tallow-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      # Synology volume path - adjust based on your NAS configuration
      # Common paths: /volume1, /volume2, /volumeUSB1, etc.
      device: ${DATA_VOLUME_PATH:-/volume1/docker/tallow/data}

  relay-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${RELAY_DATA_PATH:-/volume1/docker/tallow/relay-data}

  cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${CACHE_VOLUME_PATH:-/volume1/docker/tallow/cache}
