```mermaid
graph TB
    subgraph "Phase 1: Signaling"
        A[Sender: Create Room] --> B[Signaling Server:<br/>Generate Room Code]
        B --> C[Receiver: Join Room]
        C --> D{Both in Same Room?}
        D -->|Yes| E[Exchange PQC Public Keys]
        D -->|No| F[Error: Invalid Code]
    end

    subgraph "Phase 2: PQC Handshake"
        E --> G[Receiver: Encapsulate<br/>ML-KEM-768 + X25519]
        G --> H[Send Ciphertext to Sender]
        H --> I[Sender: Decapsulate<br/>Derive Shared Secret]
        I --> J[Both: HKDF Key Derivation<br/>â†’ Session Keys]
    end

    subgraph "Phase 3: WebRTC Negotiation"
        J --> K[Sender: Create RTCPeerConnection]
        K --> L[Sender: Create Offer SDP]
        L --> M[Encrypt Offer with Session Key]
        M --> N[Send via Signaling Server]
        N --> O[Receiver: Decrypt Offer]
        O --> P[Receiver: Create Answer SDP]
        P --> Q[Encrypt Answer]
        Q --> R[Send via Signaling Server]
        R --> S[Sender: Decrypt Answer]
    end

    subgraph "Phase 4: ICE (NAT Traversal)"
        S --> T{Gather ICE Candidates}
        T --> U[Host Candidates<br/>Local IP Addresses]
        T --> V[Server Reflexive<br/>STUN Server]
        T --> W[Relay Candidates<br/>TURN Server]

        U --> X[Exchange Candidates]
        V --> X
        W --> X

        X --> Y{Test Connectivity}
    end

    subgraph "Phase 5: Connection Selection"
        Y -->|Local Network| Z1[Direct P2P<br/>Host-to-Host<br/>Fastest]
        Y -->|Over Internet| Z2[STUN P2P<br/>NAT Traversal<br/>Fast]
        Y -->|Strict Firewall| Z3[TURN Relay<br/>Proxied<br/>Slower]
        Y -->|All Failed| Z4[Email Fallback<br/>S3 Upload]
    end

    subgraph "Phase 6: Data Channel"
        Z1 --> AA[Create RTCDataChannel]
        Z2 --> AA
        Z3 --> AA
        AA --> AB[Configure:<br/>Ordered, Reliable]
        AB --> AC{Channel State}
        AC -->|Open| AD[Ready for Transfer]
        AC -->|Failed| AE[Retry/Fallback]
    end

    subgraph "Phase 7: Transfer"
        AD --> AF[Initialize Triple Ratchet]
        AF --> AG[Send Encrypted Chunks]
        AG --> AH[Receive & Verify]
        AH --> AI[Send ACK]
        AI --> AJ{More Chunks?}
        AJ -->|Yes| AG
        AJ -->|No| AK[Transfer Complete]
    end

    subgraph "Phase 8: Cleanup"
        AK --> AL[Close Data Channel]
        AL --> AM[Close Peer Connection]
        AM --> AN[Leave Signaling Room]
        AN --> AO[Wipe Session Keys]
        AO --> AP[Update History]
    end

    F -.->|Retry| A
    AE -.->|Retry| K
    Z4 --> AQ[See Email Fallback Flow]

    %% Styling
    classDef signaling fill:#3b82f6,stroke:#1e40af,stroke-width:2px,color:#fff
    classDef crypto fill:#f59e0b,stroke:#b45309,stroke-width:2px,color:#fff
    classDef webrtc fill:#10b981,stroke:#047857,stroke-width:2px,color:#fff
    classDef ice fill:#8b5cf6,stroke:#5b21b6,stroke-width:2px,color:#fff
    classDef transfer fill:#ec4899,stroke:#be185d,stroke-width:2px,color:#fff
    classDef cleanup fill:#6b7280,stroke:#374151,stroke-width:2px,color:#fff
    classDef error fill:#ef4444,stroke:#b91c1c,stroke-width:2px,color:#fff

    class A,B,C,D signaling
    class E,G,H,I,J,M,O,Q,S crypto
    class K,L,N,P,R webrtc
    class T,U,V,W,X,Y ice
    class Z1,Z2,Z3,AA,AB,AC,AD,AF,AG,AH,AI,AJ,AK transfer
    class AL,AM,AN,AO,AP cleanup
    class F,AE,Z4,AQ error
```
