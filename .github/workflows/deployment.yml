name: Deployment Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      strategy:
        description: 'Deployment strategy'
        required: true
        default: 'blue-green'
        type: choice
        options:
          - blue-green
          - canary
          - rolling

concurrency:
  group: deployment
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DEPLOYMENT_HOST: ${{ secrets.DEPLOYMENT_HOST }}
  DEPLOYMENT_USER: ${{ secrets.DEPLOYMENT_USER }}

permissions:
  contents: read
  packages: read
  deployments: write

jobs:
  # ============================================================================
  # Verify Deployment Readiness
  # ============================================================================
  verify-deployment:
    name: Verify Deployment Readiness
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify critical secrets
        run: |
          if [ -z "${{ secrets.DEPLOYMENT_HOST }}" ]; then
            echo "ERROR: DEPLOYMENT_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.DEPLOYMENT_USER }}" ]; then
            echo "ERROR: DEPLOYMENT_USER secret is not set"
            exit 1
          fi
          echo "âœ“ All required secrets are configured"

      - name: Check main branch protection
        uses: actions/github-script@v7
        with:
          script: |
            const protection = await github.rest.repos.getBranchProtection({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: 'main'
            }).catch(() => null);

            if (protection) {
              console.log('âœ“ Branch protection is enabled');
            } else {
              console.warn('âš  No branch protection detected');
            }

  # ============================================================================
  # Create Deployment
  # ============================================================================
  create-deployment:
    name: Create Deployment Record
    needs: verify-deployment
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      deployment_id: ${{ steps.deployment.outputs.deployment_id }}

    steps:
      - name: Create GitHub deployment
        id: deployment
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.ref,
              environment: 'production',
              description: 'Deployment from GitHub Actions',
              required_contexts: [],
              auto_merge: false
            });

            core.setOutput('deployment_id', deployment.data.id);
            console.log('Created deployment:', deployment.data.id);

  # ============================================================================
  # Blue-Green Deployment
  # ============================================================================
  blue-green-deployment:
    name: Blue-Green Deployment
    needs: create-deployment
    if: github.event_name == 'push' || github.event.inputs.strategy == 'blue-green'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set deployment status to in_progress
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ needs.create-deployment.outputs.deployment_id }},
              state: 'in_progress',
              description: 'Starting blue-green deployment'
            });

      - name: Deploy to staging (Green)
        id: deploy_green
        run: |
          echo "Starting green environment deployment..."
          ssh -i "${{ secrets.DEPLOYMENT_SSH_KEY }}" \
              -o StrictHostKeyChecking=no \
              ${{ env.DEPLOYMENT_USER }}@${{ env.DEPLOYMENT_HOST }} \
              "cd /apps/tallow-green && git pull origin main && npm ci && npm run build && pm2 reload tallow-green" \
          || exit 1
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Run smoke tests on green
        id: smoke_tests_green
        continue-on-error: true
        run: |
          echo "Running smoke tests on green environment..."
          sleep 30
          curl -f https://green.tallow.manisahome.com/api/health || exit 1
          echo "âœ“ Green environment health check passed"

      - name: Switch traffic to Green
        if: steps.smoke_tests_green.outcome == 'success'
        run: |
          echo "Switching traffic to green environment..."
          ssh -i "${{ secrets.DEPLOYMENT_SSH_KEY }}" \
              -o StrictHostKeyChecking=no \
              ${{ env.DEPLOYMENT_USER }}@${{ env.DEPLOYMENT_HOST }} \
              "cd /apps/tallow && docker-compose -f docker-compose.prod.yml config | sed 's/blue/green/g' | docker-compose -f - up -d" \
          || exit 1

      - name: Run smoke tests on production
        run: |
          echo "Running smoke tests on production..."
          sleep 30
          curl -f https://tallow.manisahome.com/api/health || exit 1
          echo "âœ“ Production environment health check passed"

      - name: Set deployment status to success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ needs.create-deployment.outputs.deployment_id }},
              state: 'success',
              description: 'Blue-green deployment completed successfully',
              environment_url: 'https://tallow.manisahome.com'
            });

      - name: Set deployment status to failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ needs.create-deployment.outputs.deployment_id }},
              state: 'failure',
              description: 'Blue-green deployment failed'
            });

  # ============================================================================
  # Canary Deployment
  # ============================================================================
  canary-deployment:
    name: Canary Deployment
    needs: create-deployment
    if: github.event.inputs.strategy == 'canary'
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set deployment status to in_progress
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ needs.create-deployment.outputs.deployment_id }},
              state: 'in_progress',
              description: 'Starting canary deployment'
            });

      - name: Deploy new version to canary
        run: |
          echo "Deploying to canary (5% of traffic)..."
          ssh -i "${{ secrets.DEPLOYMENT_SSH_KEY }}" \
              -o StrictHostKeyChecking=no \
              ${{ env.DEPLOYMENT_USER }}@${{ env.DEPLOYMENT_HOST }} \
              "cd /apps/tallow-canary && git pull origin main && npm ci && npm run build && pm2 start server.js" \
          || exit 1

      - name: Route 5% traffic to canary
        run: |
          echo "Routing 5% of traffic to canary..."
          ssh -i "${{ secrets.DEPLOYMENT_SSH_KEY }}" \
              -o StrictHostKeyChecking=no \
              ${{ env.DEPLOYMENT_USER }}@${{ env.DEPLOYMENT_HOST }} \
              "docker exec tallow-lb nginx -s reload" \
          || exit 1

      - name: Monitor canary (5 minutes)
        id: monitor_5
        run: |
          echo "Monitoring canary deployment for 5 minutes (5% traffic)..."
          for i in {1..30}; do
            sleep 10
            curl -f https://tallow.manisahome.com/api/health || exit 1
            ERROR_RATE=$(curl -s https://tallow.manisahome.com/api/metrics | grep error_rate | head -1)
            echo "Check $i: $ERROR_RATE"
            if [[ $ERROR_RATE == *"0."* ]]; then
              echo "Error rate acceptable, continuing..."
            else
              echo "Error rate too high, rolling back..."
              exit 1
            fi
          done

      - name: Route 25% traffic to canary
        run: |
          echo "Increasing traffic to 25% of canary..."
          ssh -i "${{ secrets.DEPLOYMENT_SSH_KEY }}" \
              -o StrictHostKeyChecking=no \
              ${{ env.DEPLOYMENT_USER }}@${{ env.DEPLOYMENT_HOST }} \
              "docker exec tallow-lb sed -i 's/weight 1/weight 5/g' /etc/nginx/conf.d/default.conf && nginx -s reload" \
          || exit 1

      - name: Monitor canary (10 minutes at 25%%)
        id: monitor_25
        run: |
          echo "Monitoring canary deployment for 10 minutes (25% traffic)..."
          for i in {1..60}; do
            sleep 10
            curl -f https://tallow.manisahome.com/api/health || exit 1
          done

      - name: Route 100% traffic to canary
        run: |
          echo "Routing all traffic to canary..."
          ssh -i "${{ secrets.DEPLOYMENT_SSH_KEY }}" \
              -o StrictHostKeyChecking=no \
              ${{ env.DEPLOYMENT_USER }}@${{ env.DEPLOYMENT_HOST }} \
              "docker exec tallow-lb sed -i 's/weight 5/weight 1/g' /etc/nginx/conf.d/default.conf && nginx -s reload" \
          || exit 1

      - name: Final verification
        run: |
          sleep 30
          curl -f https://tallow.manisahome.com/api/health || exit 1
          echo "âœ“ Canary deployment completed successfully"

      - name: Set deployment status to success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ needs.create-deployment.outputs.deployment_id }},
              state: 'success',
              description: 'Canary deployment completed successfully',
              environment_url: 'https://tallow.manisahome.com'
            });

  # ============================================================================
  # Automated Rollback
  # ============================================================================
  automated-rollback:
    name: Automated Rollback
    needs: [create-deployment, blue-green-deployment]
    if: failure()
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Trigger rollback
        run: |
          echo "Deployment failed! Initiating rollback..."
          ssh -i "${{ secrets.DEPLOYMENT_SSH_KEY }}" \
              -o StrictHostKeyChecking=no \
              ${{ env.DEPLOYMENT_USER }}@${{ env.DEPLOYMENT_HOST }} \
              "cd /apps/tallow && git revert HEAD --no-edit && npm run build && pm2 reload tallow" \
          || exit 1

      - name: Verify rollback
        run: |
          sleep 30
          curl -f https://tallow.manisahome.com/api/health || exit 1
          echo "âœ“ Rollback completed successfully"

      - name: Set deployment status to error
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ needs.create-deployment.outputs.deployment_id }},
              state: 'error',
              description: 'Deployment failed and was rolled back'
            });

      - name: Create incident issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âš ï¸ Deployment Rollback - ${new Date().toISOString()}`,
              body: `
## Deployment Rollback Report

**Commit:** ${context.sha}
**Branch:** ${context.ref}
**Workflow Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

### Actions Taken
- Automatic rollback executed
- Previous version restored
- Health checks passed

### Investigation Required
Please investigate the deployment failure and address the issues before re-deployment.
              `,
              labels: ['incident', 'deployment', 'automated']
            });

            console.log('Created incident issue:', issue.data.number);

  # ============================================================================
  # Post-Deployment Monitoring
  # ============================================================================
  post-deployment-monitoring:
    name: Post-Deployment Monitoring
    needs: [create-deployment, blue-green-deployment]
    if: success()
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Verify production health
        run: |
          echo "Running comprehensive health checks..."
          for i in {1..3}; do
            curl -f https://tallow.manisahome.com/api/health || exit 1
            curl -f https://tallow.manisahome.com/api/metrics || exit 1
            sleep 5
          done
          echo "âœ“ All health checks passed"

      - name: Check error rates
        run: |
          ERROR_RATE=$(curl -s https://tallow.manisahome.com/api/metrics | grep error_rate | head -1 | awk '{print $2}')
          if (( $(echo "$ERROR_RATE > 1.0" | bc -l) )); then
            echo "ERROR: Error rate too high: $ERROR_RATE%"
            exit 1
          fi
          echo "âœ“ Error rate acceptable: $ERROR_RATE%"

      - name: Performance metrics check
        run: |
          RESPONSE_TIME=$(curl -s https://tallow.manisahome.com/api/metrics | grep response_time | head -1 | awk '{print $2}')
          echo "Average response time: ${RESPONSE_TIME}ms"
          if (( $(echo "$RESPONSE_TIME > 1000" | bc -l) )); then
            echo "WARNING: Response time elevated"
          fi

      - name: Create deployment summary
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `
## ðŸš€ Deployment Successful

**Commit:** ${context.sha.substring(0, 7)}
**Version:** Production
**Time:** ${new Date().toISOString()}

### Health Status
- âœ“ API Health: Operational
- âœ“ Error Rate: < 1%
- âœ“ Response Time: Normal
- âœ“ Database: Connected

### Deployment Logs
[View Workflow Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `;

            console.log(summary);
