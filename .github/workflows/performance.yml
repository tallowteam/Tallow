name: Performance Testing

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  # Allow manual triggering
  workflow_dispatch:

# Cancel in-progress runs for same workflow and branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  # Job 1: Bundle Size & Transfer Speed Tests
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Run bundle size analysis
        id: bundle
        run: npm run perf:bundle
        continue-on-error: true

      - name: Run transfer speed benchmarks
        id: transfer
        run: npm run perf:transfer
        continue-on-error: true

      - name: Run Web Vitals estimation
        id: vitals
        run: npm run perf:vitals
        continue-on-error: true

      - name: Upload performance report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance-report.json
          retention-days: 30

      - name: Check if tests failed
        if: steps.bundle.outcome == 'failure' || steps.transfer.outcome == 'failure'
        run: |
          echo "::error::Performance tests failed. Review bundle size or transfer speed benchmarks."
          exit 1

  # Job 2: Lighthouse CI Audits
  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Start server in background
        run: npm run start &
        env:
          CI: true

      - name: Wait for server to be ready
        run: npx wait-on http://localhost:3000 --timeout 60000

      - name: Run Lighthouse CI
        id: lighthouse
        run: npm run perf:ci
        continue-on-error: true

      - name: Upload Lighthouse results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results
          path: lighthouse-results/
          retention-days: 30

      - name: Create Lighthouse summary
        if: always()
        run: |
          echo "## Lighthouse CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Lighthouse audits completed. Check artifacts for detailed reports." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f lighthouse-results/manifest.json ]; then
            echo "Reports available in lighthouse-results/" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check Lighthouse status
        if: steps.lighthouse.outcome == 'failure'
        run: |
          echo "::warning::Lighthouse CI failed performance budgets. Review the reports for details."
          exit 1

  # Job 3: Performance Summary
  performance-summary:
    name: Performance Summary
    runs-on: ubuntu-latest
    needs: [performance-tests, lighthouse]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Download performance report
        uses: actions/download-artifact@v4
        with:
          name: performance-report
        continue-on-error: true

      - name: Download Lighthouse results
        uses: actions/download-artifact@v4
        with:
          name: lighthouse-results
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "# Performance Testing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f performance-report.json ]; then
            echo "### Bundle Size & Transfer Speed" >> $GITHUB_STEP_SUMMARY
            echo "- Performance report generated successfully" >> $GITHUB_STEP_SUMMARY
            echo "- Check artifacts for detailed metrics" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Bundle Size & Transfer Speed" >> $GITHUB_STEP_SUMMARY
            echo "- No performance report found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Lighthouse CI" >> $GITHUB_STEP_SUMMARY

          if [ -d lighthouse-results ]; then
            echo "- Lighthouse audits completed" >> $GITHUB_STEP_SUMMARY
            echo "- Check artifacts for detailed reports" >> $GITHUB_STEP_SUMMARY
          else
            echo "- No Lighthouse results found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Performance Report: Contains bundle size, transfer speed, and Web Vitals data" >> $GITHUB_STEP_SUMMARY
          echo "- Lighthouse Results: Contains detailed Lighthouse audit reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download artifacts from the workflow run to review detailed results." >> $GITHUB_STEP_SUMMARY

      - name: Check overall status
        if: needs.performance-tests.result == 'failure' || needs.lighthouse.result == 'failure'
        run: |
          echo "::error::Performance testing failed. Review the test results and artifacts."
          exit 1
