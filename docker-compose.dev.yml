# Docker Compose for Development Environment
# Hot reload, debugging, and development tools enabled

version: '3.8'

services:
  # Tallow Web App - Development
  tallow-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
      args:
        - NODE_ENV=development
    image: tallow:dev
    container_name: tallow-dev
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      # Mount source code for hot reload
      - .:/app
      - /app/node_modules
      - /app/.next
    environment:
      - NODE_ENV=development
      - NEXT_TELEMETRY_DISABLED=1
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
      - NEXT_PUBLIC_SIGNALING_URL=ws://localhost:3001
      # Development environment variables
      - NEXT_PUBLIC_TURN_SERVER=${NEXT_PUBLIC_TURN_SERVER:-}
      - NEXT_PUBLIC_TURN_USERNAME=${NEXT_PUBLIC_TURN_USERNAME:-}
      - NEXT_PUBLIC_TURN_CREDENTIAL=${NEXT_PUBLIC_TURN_CREDENTIAL:-}
      - NEXT_PUBLIC_FORCE_RELAY=${NEXT_PUBLIC_FORCE_RELAY:-false}
      - NEXT_PUBLIC_ALLOW_DIRECT=${NEXT_PUBLIC_ALLOW_DIRECT:-true}
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
      - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY:-}
    depends_on:
      - signaling-dev
    networks:
      - tallow-dev-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Signaling Server - Development
  signaling-dev:
    build:
      context: .
      dockerfile: Dockerfile.signaling
    image: tallow-signaling:dev
    container_name: tallow-signaling-dev
    restart: unless-stopped
    ports:
      - "3001:3001"
    volumes:
      # Mount signaling server for hot reload
      - ./signaling-server.js:/app/signaling-server.js:ro
    environment:
      - SIGNALING_PORT=3001
      - NODE_ENV=development
      - ALLOWED_ORIGINS=http://localhost:3000,http://127.0.0.1:3000
    networks:
      - tallow-dev-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis for caching (optional)
  redis-dev:
    image: redis:7-alpine
    container_name: tallow-redis-dev
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-dev-data:/data
    networks:
      - tallow-dev-network
    profiles:
      - cache

  # Mailhog for email testing
  mailhog:
    image: mailhog/mailhog:latest
    container_name: tallow-mailhog
    restart: unless-stopped
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI
    networks:
      - tallow-dev-network
    profiles:
      - email

  # Adminer for database management (if needed)
  adminer:
    image: adminer:latest
    container_name: tallow-adminer
    restart: unless-stopped
    ports:
      - "8080:8080"
    networks:
      - tallow-dev-network
    profiles:
      - db

networks:
  tallow-dev-network:
    driver: bridge

volumes:
  redis-dev-data:
    driver: local
